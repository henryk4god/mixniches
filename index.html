<div id="product-ideas-widget">
  <style>
    :root {
      --primary-color: #6c5ce7;
      --secondary-color: #a29bfe;
      --bg-color: #f9f9f9;
      --card-bg: #ffffff;
      --text-color: #333333;
      --accent-color: #00cec9;
      --error-color: #d63031;
      --success-color: #00b894;
      --product-name-color: #6c5ce7;
      --section-title-color: #00b894;
      --border-radius: 12px;
      --box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
      --transition: all 0.3s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    #product-ideas-widget {
      font-family: 'Poppins', sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 2rem;
      background: var(--bg-color);
      border-radius: var(--border-radius);
      color: var(--text-color);
    }

    .widget-header {
      text-align: center;
      margin-bottom: 2rem;
      animation: fadeIn 0.8s ease;
    }

    .widget-title {
      font-size: 1.8rem;
      margin-bottom: 0.5rem;
      color: var(--primary-color);
      font-weight: 600;
    }

    .widget-subtitle {
      font-size: 1rem;
      color: var(--text-color);
      opacity: 0.8;
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .input-field {
      width: 100%;
      padding: 0.8rem 1rem;
      border: 2px solid #e0e0e0;
      border-radius: var(--border-radius);
      font-family: 'Poppins', sans-serif;
      font-size: 0.9rem;
      transition: var(--transition);
    }

    .input-field:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.2);
    }

    .btn {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 0.8rem 1.5rem;
      font-size: 1rem;
      font-weight: 500;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: var(--transition);
      font-family: 'Poppins', sans-serif;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .btn:hover {
      background: var(--secondary-color);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(108, 92, 231, 0.3);
    }

    .btn:disabled {
      background: #cccccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-copy {
      background: var(--accent-color);
      margin-left: 1rem;
    }

    .btn-copy:hover {
      background: #00a8a8;
    }

    .results-container {
      margin-top: 2rem;
      display: none;
      animation: fadeIn 0.8s ease;
    }

    .results-title {
      font-size: 1.3rem;
      margin-bottom: 1rem;
      color: var(--primary-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .product-card {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: var(--box-shadow);
      transition: var(--transition);
    }

    .product-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
    }

    .product-name {
      font-weight: 700;
      color: var(--product-name-color);
      margin-bottom: 1rem;
      font-size: 1.2rem;
      line-height: 1.4;
    }

    .product-type {
      font-weight: 600;
      color: var(--section-title-color);
      margin-bottom: 0.5rem;
    }

    .product-description {
      color: var(--text-color);
      line-height: 1.6;
      margin-bottom: 1rem;
    }

    .product-features, .product-monetization {
      margin: 1rem 0;
    }

    .product-features h4, .product-monetization h4 {
      color: var(--section-title-color);
      margin-bottom: 0.5rem;
      font-size: 1rem;
    }

    .product-features-list {
      color: var(--text-color);
      line-height: 1.6;
      padding-left: 1rem;
    }

    .loading {
      display: none;
      text-align: center;
      margin: 2rem 0;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(108, 92, 231, 0.1);
      border-radius: 50%;
      border-top-color: var(--primary-color);
      animation: spin 1s ease-in-out infinite;
      margin: 0 auto 1rem;
    }

    .error-message {
      color: var(--error-color);
      text-align: center;
      margin: 1rem 0;
      display: none;
    }

    .success-message {
      color: var(--success-color);
      text-align: center;
      margin: 1rem 0;
      display: none;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    /* Mobile Responsiveness Enhancements */
    @media (max-width: 768px) {
      #product-ideas-widget {
        padding: 1.5rem;
        margin: 0.5rem;
        border-radius: 10px;
      }
      
      .widget-title {
        font-size: 1.5rem;
        line-height: 1.3;
      }
      
      .widget-subtitle {
        font-size: 0.9rem;
        line-height: 1.4;
      }
      
      .input-group {
        gap: 0.8rem;
      }
      
      .input-field {
        padding: 0.75rem 1rem;
        font-size: 0.9rem;
      }
      
      .btn {
        width: 100%;
        padding: 0.9rem 1.5rem;
        font-size: 1rem;
      }
      
      .btn-copy {
        margin-left: 0;
        margin-top: 1rem;
        width: 100%;
      }
      
      .results-title {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.8rem;
        font-size: 1.2rem;
      }
      
      .product-card {
        padding: 1.2rem;
        margin-bottom: 1.2rem;
      }
      
      .product-name {
        font-size: 1.1rem;
        margin-bottom: 0.8rem;
      }
      
      .product-type, .product-description {
        font-size: 0.95rem;
      }
      
      .product-features h4, .product-monetization h4 {
        font-size: 0.95rem;
      }
      
      .product-features-list {
        padding-left: 0.8rem;
      }
      
      .loading {
        margin: 1.5rem 0;
      }
      
      .spinner {
        width: 35px;
        height: 35px;
      }
    }
    
    @media (max-width: 480px) {
      #product-ideas-widget {
        padding: 1rem;
        margin: 0.25rem;
        border-radius: 8px;
      }
      
      .widget-header {
        margin-bottom: 1.5rem;
      }
      
      .widget-title {
        font-size: 1.3rem;
      }
      
      .widget-subtitle {
        font-size: 0.85rem;
      }
      
      .input-group {
        margin-bottom: 1.2rem;
      }
      
      .input-field {
        padding: 0.7rem 0.9rem;
        font-size: 0.85rem;
      }
      
      .btn {
        padding: 0.8rem 1.2rem;
        font-size: 0.95rem;
      }
      
      .results-title {
        font-size: 1.1rem;
      }
      
      .product-card {
        padding: 1rem;
        margin-bottom: 1rem;
      }
      
      .product-name {
        font-size: 1rem;
      }
      
      .product-type, .product-description {
        font-size: 0.9rem;
      }
      
      .product-features h4, .product-monetization h4 {
        font-size: 0.9rem;
      }
      
      .product-features-list {
        font-size: 0.9rem;
      }
    }
    
    /* Small screen optimization */
    @media (max-width: 360px) {
      #product-ideas-widget {
        padding: 0.8rem;
      }
      
      .widget-title {
        font-size: 1.2rem;
      }
      
      .input-field {
        padding: 0.65rem 0.8rem;
      }
      
      .btn {
        padding: 0.75rem 1rem;
      }
    }
    
    /* Fix for very tall screens */
    @media (max-height: 600px) and (orientation: landscape) {
      #product-ideas-widget {
        padding: 1rem;
      }
      
      .widget-header {
        margin-bottom: 1.2rem;
      }
      
      .input-group {
        margin-bottom: 1rem;
      }
      
      .results-container {
        margin-top: 1.5rem;
      }
    }
  </style>

  <div class="widget-header">
    <h1 class="widget-title">Get Unique Product Ideas</h1>
    <p class="widget-subtitle">Mix your expertise with trending questions to generate innovative digital products</p>
  </div>

  <div class="input-group">
    <input type="text" id="niche-input" class="input-field" placeholder="Enter your specialist area (e.g., fitness coaching, graphic design)">
    <input type="text" id="questions-input" class="input-field" placeholder="Enter trending questions from different niches (e.g., How to save time?, How to stay motivated?)">
  </div>

  <button id="generate-btn" class="btn">
    <span>Get Unique Product Ideas</span>
  </button>

  <div class="loading">
    <div class="spinner"></div>
    <p>Generating unique product ideas...</p>
  </div>

  <div class="error-message"></div>
  <div class="success-message"></div>

  <div class="results-container">
    <h2 class="results-title">
      <span>Your Unique Product Ideas</span>
      <button id="copy-all-btn" class="btn btn-copy">Copy All</button>
    </h2>
    <div id="product-results"></div>
  </div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // âš ï¸ IMPORTANT: REPLACE THIS PLACEHOLDER WITH YOUR DEPLOYED GAS WEB APP URL
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbx0CL26bY-2FaoGYycw03-hEYssOPgK8vkEH3nNS7kixnUgW1pulMDVKmvZXRR327LLaw/exec';

        const generateBtn = document.getElementById('generate-btn');
        const nicheInput = document.getElementById('niche-input');
        const questionsInput = document.getElementById('questions-input');
        const loadingElement = document.querySelector('.loading');
        const resultsContainer = document.querySelector('.results-container');
        const productResults = document.getElementById('product-results');
        const errorMessage = document.querySelector('.error-message');
        const successMessage = document.querySelector('.success-message');
        const copyAllBtn = document.getElementById('copy-all-btn');

        generateBtn.addEventListener('click', generateProductIdeas);
        copyAllBtn.addEventListener('click', copyAllResults);

        async function generateProductIdeas() {
            const niche = nicheInput.value.trim();
            const questions = questionsInput.value.trim();

            if (!niche || !questions) {
                showError('Please fill in both fields');
                return;
            }

            // Clear previous results and errors
            productResults.innerHTML = '';
            hideError();
            hideSuccess();

            // Show loading state
            generateBtn.disabled = true;
            loadingElement.style.display = 'block';
            resultsContainer.style.display = 'none';

            try {
                // ðŸ› ï¸ FIX 1: Use FormData to create a "Simple Request" and bypass the CORS preflight.
                const formData = new FormData();
                formData.append('niche', niche);
                formData.append('questions', questions);

                // 2. Fetch the Google Apps Script Web App URL (the proxy)
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    // ðŸ› ï¸ FIX 2: Do NOT set Content-Type here. The browser will set it correctly (multipart/form-data),
                    // which allows GAS to read the data via e.parameter.
                    body: formData 
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                // The GAS backend returns a JSON object: { success: true/false, data: { ... } or error: '...' }
                const data = await response.json();

                if (data.success === false) {
                    throw new Error(data.error || 'Unknown error from the Apps Script backend.');
                }

                // Extract the content from the AI response payload
                const content = data.data?.choices?.[0]?.message?.content;

                if (!content) {
                    throw new Error('No content received from AI via the backend proxy.');
                }

                // Process and display results
                displayResults(content);
                showSuccess('Product ideas generated successfully!');
            } catch (error) {
                console.error('Error:', error);
                showError(`Failed to generate product ideas: ${error.message}.`);
            } finally {
                loadingElement.style.display = 'none';
                generateBtn.disabled = false;
            }
        }

        // --- Utility Functions (Keep as they are) ---

        function displayResults(content) {
            // Split content by numbered items
            const products = content.split(/\d+\./).filter(item => item.trim());

            products.forEach((product, index) => {
                if (!product.trim()) return;

                // Create card container
                const card = document.createElement('div');
                card.className = 'product-card';

                // Parse product details
                const nameMatch = product.match(/\*\*([^*]+)\*\*/);
                const typeMatch = product.match(/\*\*Type:\*\*(.+?)(?=\n\*\*|$)/s);
                const descMatch = product.match(/\*\*Description:\*\*(.+?)(?=\n\*\*|$)/s);
                const featuresMatch = product.match(/\*\*Features:\*\*(.+?)(?=\n\*\*|$)/s);
                const monetizationMatch = product.match(/\*\*Monetization:\*\*(.+?)(?=\n\d+\.|$)/s);

                // Build card content
                let cardContent = '';

                // Add product name/number
                if (nameMatch) {
                    cardContent += `<div class="product-name">${index+1}. <strong>${nameMatch[1].trim()}</strong></div>`;
                }

                // Add type
                if (typeMatch) {
                    cardContent += `<div class="product-type"><strong>Type:</strong> ${typeMatch[1].trim()}</div>`;
                }

                // Add description
                if (descMatch) {
                    cardContent += `<div class="product-description"><strong>Description:</strong> ${descMatch[1].trim()}</div>`;
                }

                // Add features
                if (featuresMatch) {
                    const featuresList = featuresMatch[1]
                        .split('\n- ').filter(item => item.trim())
                        .map(item => `<li>${item.trim()}</li>`).join('');

                    cardContent += `
                        <div class="product-features">
                            <h4>Features:</h4>
                            <ul class="product-features-list">${featuresList}</ul>
                        </div>`;
                }

                // Add monetization
                if (monetizationMatch) {
                    cardContent += `
                        <div class="product-monetization">
                            <h4>Monetization:</h4>
                            <p>${monetizationMatch[1].trim()}</p>
                        </div>`;
                }

                card.innerHTML = cardContent;
                productResults.appendChild(card);
            });

            resultsContainer.style.display = 'block';

            // Scroll to results
            setTimeout(() => {
                resultsContainer.scrollIntoView({ behavior: 'smooth' });
            }, 300);
        }

        function copyAllResults() {
            const textToCopy = Array.from(document.querySelectorAll('.product-card'))
                .map(card => card.textContent)
                .join('\n\n');

            navigator.clipboard.writeText(textToCopy)
                .then(() => {
                    copyAllBtn.textContent = 'Copied!';
                    setTimeout(() => {
                        copyAllBtn.textContent = 'Copy All';
                    }, 2000);
                })
                .catch(err => {
                    console.error('Failed to copy: ', err);
                });
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            setTimeout(() => {
                errorMessage.style.animation = 'fadeIn 0.3s ease';
            }, 10);
        }

        function hideError() {
            errorMessage.style.display = 'none';
        }

        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            setTimeout(() => {
                successMessage.style.animation = 'fadeIn 0.3s ease';
            }, 10);

            setTimeout(() => {
                successMessage.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => {
                    successMessage.style.display = 'none';
                }, 300);
            }, 3000);
        }

        function hideSuccess() {
            successMessage.style.display = 'none';
        }
    });
</script>
</div>
